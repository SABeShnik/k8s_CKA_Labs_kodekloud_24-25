1. In this lab, we will learn about PriorityClasses in Kubernetes.
Which of the following PriorityClasses are part of a default Kubernetes setup?

- system-critical
- system-cluster-critical <---------------
- high-memory-priority
- burstable-priority
- gold-priority

Hint:
To list all the existing PriorityClasses, run the following command:
kubectl get priorityclass

Solution:
Listing the PriorityClasses available shows the following:
controlplane ~ ➜  kubectl get priorityclasses
NAME                      VALUE        GLOBAL-DEFAULT   AGE     PREEMPTIONPOLICY
system-cluster-critical   2000000000   false            3m54s   PreemptLowerPriority <---------------
system-node-critical      2000001000   false            3m54s   PreemptLowerPriority
-------------------------------------------------------------------------------------




2. What is the priority value assigned to system-node-critical?
- 2000001000 <---------------
- 100000
- 1000000000
- 50000

Hint: 
Run this command to inspect the details of a built-in PriorityClass:
kubectl describe priorityclass system-node-critical

root@controlplane ~ ➜  kubectl get  priorityclasses
NAME                      VALUE        GLOBAL-DEFAULT   AGE   PREEMPTIONPOLICY
system-cluster-critical   2000000000   false            23m   PreemptLowerPriority
system-node-critical      2000001000   false            23m   PreemptLowerPriority

Solution: 
Listing the details of the system-node-critical class shows the following:

controlplane ~ ➜  kubectl describe priorityclass system-node-critical
Name:              system-node-critical
Value:             2000001000
GlobalDefault:     false
PreemptionPolicy:  PreemptLowerPriority
Description:       Used for system critical pods that must not be moved from their current node.
Annotations:       <none>
Events:            <none>
-------------------------------------------------------------------------------------




3. What is the value of preemptionPolicy in system-node-critical?
- Always
- Not Set
- PreemptLowerPriority <---------------
- Never

root@controlplane ~ ➜  kubectl describe priorityclasses system-cluster-critical | grep -i preem
PreemptionPolicy:  PreemptLowerPriority

Hint:
Run this command to check if preemptionPolicy is set for the system-node-critical class:
kubectl get priorityclass system-node-critical -o yaml

Solution:
Viewing the configuration of the system-node-critical class shows:
controlplane ~ ➜  kubectl get priorityclass system-node-critical -o yaml
apiVersion: scheduling.k8s.io/v1
description: Used for system critical pods that must not be moved from their current
  node.
kind: PriorityClass
metadata:
  creationTimestamp: "2025-04-24T02:14:51Z"
  generation: 1
  name: system-node-critical
  resourceVersion: "68"
  uid: e0ce2074-6007-4f62-993f-0d46c50f31cd
preemptionPolicy: PreemptLowerPriority
value: 2000001000
-------------------------------------------------------------------------------------



4. Create a PriorityClass named high-priority, a value of 100000, and a preemption policy of PreemptLowerPriority. Do not set this class as a global default.

kubectl create priorityclass high-priority --value=100000 --preemption-policy="PreemptLowerPriority" --global-default=false --description="Created by SAB" 
 --- vvv ---
root@controlplane ~ ➜  kubectl create priorityclass high-priority --value=100000 --preemption-policy="PreemptLowerPriority" --global-default=false --description="Created by SAB"
priorityclass.scheduling.k8s.io/high-priority created

Hint:
Run the command below to confirm creation:
kubectl get priorityclass high-priority

Solution:
To create the class high-priority, create a new yaml file:
vi high-priority.yaml

Add the contents of the yaml file:
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: high-priority
value: 100000
globalDefault: false
description: "This priority class is used for high-priority pods."
preemptionPolicy: PreemptLowerPriority
Save the file using :wq. To create the resource:

kubectl apply -f high-priority.yaml
You should be able to see the new resource if you listed the available priority classes using:

kubectl get priorityclasses
root@controlplane ~ ➜  kubectl get priorityclass
NAME                      VALUE        GLOBAL-DEFAULT   AGE     PREEMPTIONPOLICY
high-priority             100000       false            2m17s   PreemptLowerPriority
system-cluster-critical   2000000000   false            34m     PreemptLowerPriority
system-node-critical      2000001000   false            34m     PreemptLowerPriority
-------------------------------------------------------------------------------------



5. Create another PriorityClass named low-priority with a value of 1000. Do not set this class as a global default.

root@controlplane ~ ➜  kubectl create priorityclass low-priority --value=1000 --global-default=false
 --description="Created by SAB"
priorityclass.scheduling.k8s.io/low-priority created

root@controlplane ~ ➜  kubectl get priorityclass
NAME                      VALUE        GLOBAL-DEFAULT   AGE     PREEMPTIONPOLICY
high-priority             100000       false            4m16s   PreemptLowerPriority
low-priority              1000         false            16s     PreemptLowerPriority
system-cluster-critical   2000000000   false            36m     PreemptLowerPriority
system-node-critical      2000001000   false            36m     PreemptLowerPriority

Hint:
Run the command below to confirm creation:
kubectl get priorityclass low-priority

Solution:
To create the class low-priority, create a new yaml file:

vi low-priority.yaml
Add the contents of the yaml file:

apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: low-priority
value: 1000
globalDefault: false
description: "This priority class is used for low-priority pods."
Save the file using :wq. To create the resource:

kubectl apply -f low-priority.yaml
You should be able to see the new resource if you listed the available priority classes using:

kubectl get priorityclasses
-------------------------------------------------------------------------------------



6. In the default namespace, create a pod named low-prio-pod that runs an nginx image and uses the low-priority PriorityClass.

vi mypodPC.yaml

apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    env: test
spec:
  containers:
  - name: nginx
    image: nginx
    imagePullPolicy: IfNotPresent
  priorityClassName: low-priority

  root@controlplane ~ ➜  kubectl apply -f mypodPC.yaml 
pod/nginx created

root@controlplane ~ ➜  kubectl get pod
NAME    READY   STATUS    RESTARTS   AGE
nginx   1/1     Running   0          25s

Hint:
Review documentation available at https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/

Solution:
Here is a sample yaml for the pod low-prio-pod:

# low-prio-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: low-prio-pod
spec:
  containers:
  - name: nginx
    image: nginx
  priorityClassName: low-priority
To create the resource:

kubectl apply -f low-prio-pod.yaml
-------------------------------------------------------------------------------------



7. Now, create another pod in the default namespace named high-prio-pod that runs an nginx image and uses the high-priority PriorityClass.

root@controlplane ~ ➜  cp mypodPC.yaml mypodPC-HiPr.yaml 
vi mypodPC-HiPr.yaml 

apiVersion: v1
kind: Pod
metadata:
  name: high-prio-pod
  labels:
    env: test
spec:
  containers:
  - name: nginx
    image: nginx
  priorityClassName: high-priority

  root@controlplane ~ ➜  kubectl apply -f mypodPC-HiPr.yaml 
pod/high-prio-pod created

Hint:
Review documentation available at https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/

Solution:
Here is a sample yaml for the pod high-prio-pod:

# high-prio-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: high-prio-pod
spec:
  containers:
  - name: nginx
    image: nginx
  priorityClassName: high-priority
To create the resource:

kubectl apply -f high-prio-pod.yaml
-------------------------------------------------------------------------------------



8. You can compare the priority classes on both pods using the following command:
kubectl get pods -o custom-columns="NAME:.metadata.name,PRIORITY:.spec.priorityClassName"

root@controlplane ~ ➜  kubectl get pods -o custom-columns="NAME:.metadata.name,PRIORITY:.spec.priorityClassName"
NAME            PRIORITY
high-prio-pod   high-priority
low-prio-pod    low-priority



9. The following assets have been provisioned on the environment:

A pod named low-app
A pod named critical-app
View the pod status using the following command: 
kubectl get pods
Which of the following is true?

- Both pods are in CrashLoopBackOff
- All pods are evicted
- Both pods are running
- critical-app pod running and low-app pod pending
- critical-app pod pending and low-app pod running <---------------


root@controlplane ~ ➜  kubectl get pods
NAME            READY   STATUS    RESTARTS   AGE
critical-app    0/1     Pending   0          101s <---------------
high-prio-pod   1/1     Running   0          6m8s
low-app         1/1     Running   0          101s
low-prio-pod    1/1     Running   0          9m3s
-------------------------------------------------------------------------------------




10. The pod critical-app is stuck in Pending state due to the low-app pod getting scheduled and requesting high resources.
Check the status of the critical-app pod using the following command:

kubectl describe pod critical-app
Status:           Pending
Events:
  Type     Reason            Age                 From               Message
  ----     ------            ----                ----               -------
  Warning  FailedScheduling  58s (x2 over 6m7s)  default-scheduler  0/1 nodes are available: 1 Insufficient cpu, 1 Insufficient memory. no new claims to deallocate, preemption: 0/1 nodes are available: 1 No preemption victims found for incoming pod.

You should see a similar message in the Events section:
Events:
  Type     Reason            Age   From               Message
  ----     ------            ----  ----               -------
  Warning  FailedScheduling  21s   default-scheduler  0/1 nodes are available ...
-------------------------------------------------------------------------------------



11. To resolve this situation and get the critical-app to a running state, you should:

- Assign the high-priority class to the critical-app
- Delete and recreate the pod with the new priority
Make sure the pod is in running state after applying the actions.

Hint:
Review documentation available at https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/
To delete a pod, run:
kubectl delete pod <POD-NAME>

Solution:
To update the manifest file of the critical-app pod, save a copy of the manifest file:

kubectl get pod critical-app -o yaml > critical-app.yaml
Edit the saved copy as follows (Output truncated below):

# critical-app.yaml
apiVersion: v1
kind: Pod
metadata:
  ...
  name: critical-app
  ...
spec:
  containers:
  - image: nginx
    imagePullPolicy: Always
    name: critical-container
    ...
  dnsPolicy: ClusterFirst
  priorityClassName: high-priority   # Add the high-priority class
  enableServiceLinks: true
  preemptionPolicy: PreemptLowerPriority
  priority: 0  # Remove this line as this is the old default priority
  ...
Note:

You must add priorityClassName: high-priority under the spec field.
You must remove the line priority: 0 if it exists in the spec to avoid conflicting priority settings.
Save the file using :wq! and then delete the old critical-app pod:

kubectl delete pod critical-app
Apply the new updated manifest file:

kubectl apply -f critical-app.yaml
Ensure the pod is now in running state:

kubectl get pod critical-app
-------------------------------------------------------------------------------------

root@controlplane ~ ➜  kubectl get pods critical-app -oyaml > critical-app.yaml
root@controlplane ~ ✦ ➜  cp critical-app.yaml critical-app-BKP.yaml 

root@controlplane ~ ✦ ➜  kubectl delete -f critical-app.yaml 
pod "critical-app" deleted from default namespace

root@controlplane ~ ✦ ➜  kubectl apply -f critical-app.yaml 
pod/critical-app created
-------------------------------------------------------------------------------------
